---
title: "useEffectã®ç¬¬äºŒå¼•æ•°ã®é…åˆ—ã‚’ç©ºã«ã™ã‚‹ã¨stateãŒæ›´æ–°ã•ã‚Œãªã„ä»¶"
emoji: "ğŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["React", "JavaScript"]
published: true
---

## æ¦‚è¦

ã‚¿ã‚¤ãƒˆãƒ«ã®é€šã‚Šã«ãªã‚Šã¾ã™ãŒã€ã“ã®å‰`useEffect`ã®æŒ™å‹•ã‚’ã†ã£ã‹ã‚Šå¿˜ã‚Œã¦ãƒãƒã£ã¦ã—ã¾ã£ãŸã®ã§ã€ãã®è§£æ±ºç­–ã‚’ãƒ¡ãƒ¢ã€‚

## stateãŒæ›´æ–°ã•ã‚Œãªã„çŠ¶æ³ã¨ã¯

`useEffect`ã§ç¬¬äºŒå¼•æ•°ã®ä¾å­˜é…åˆ—ã‚’ç©ºã«ã—ã¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒã‚¦ãƒ³ãƒˆæ™‚ã«ãªã‚“ã‚‰ã‹ã®å‡¦ç†ã•ã›ãŸã„æ™‚ã‚ã‚Šã¾ã™ã‚ˆã­ã€‚
ãã‚“ãªæ™‚ã«stateã‚’å‚ç…§ã—ã¦ã‚‚æ›´æ–°ã•ã‚Œãªã„ã‚ˆã¨ã„ã†è©±ã§ã™ã€‚

åŸºæœ¬çš„ã¯ä¾å­˜é…åˆ—ã«stateæ¸¡ã›ã‚ˆã£ã¦è©±ãªã®ã§ã€ã‚ã‚“ã¾ã‚Šä¸Šè¨˜ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã¯ãªã„ã®ã§ã™ãŒã€å•é¡Œã«ãªã‚‹ã®ã¯`setInterval`ã¨ã‹`addEventListener`ã¨ã‹ã‚’ãƒã‚¦ãƒ³ãƒˆæ™‚ã«ä½¿ã†æ™‚ã§ã™ã­ã€‚

ç§ã®å ´åˆã¯ã¡ã‚‡ã£ã¨ç‰¹æ®Šã ã£ãŸã®ã§ã™ãŒã€`WebSocket`ã‚’å®Ÿè£…ã—ãŸã‚±ãƒ¼ã‚¹ã§å•é¡Œã«ãªã£ãŸã®ã§ã€ä»Šå›ã¯ãã‚Œã‚’ä¾‹ã«ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

`WebSocket`ã‚ã‹ã‚‰ãªã„æ–¹ã¯éåŒæœŸé€šä¿¡ã‚’è¡Œã£ã¦ã‚‹ã£ã¦ã“ã¨ã ã‘ã‚ã‹ã‚Œã°å¤§ä¸ˆå¤«ã ã¨æ€ã„ã¾ã™ã€‚

å‚è€ƒURL: [https://developer.mozilla.org/ja/docs/Web/API/WebSocket](https://developer.mozilla.org/ja/docs/Web/API/WebSocket)

### stateãŒæ›´æ–°ã•ã‚Œãªã„ã‚³ãƒ¼ãƒ‰

ã¾ãšã¯å…¨ä½“ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã€‚

```jsx
import React, { useEffect, useState, useRef } from "react";

const Index = () => {
  const [fruit, setFruit] = useState("orange");
  const ws = useRef();

  const selectFruit = e => {
    // ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡
    // ä»Šå›ã¯"wss://echo.websocket.org"ã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ã£ã¦ã‚‹ã®ã§ã€é€ä¿¡ãŒæˆåŠŸã™ã‚‹ã¨ã€é€ã£ãŸå†…å®¹ãŒãã®ã¾ã¾è¿”ã£ã¦ãã‚‹
    // çµæœã¨ã—ã¦ã€€messageã€€ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹
    ws.current.send(e.currentTarget.getAttribute("data-fruit"));
  };

  useEffect(() => {
    // ã“ã® URL ã«WebSocketã§ãƒ‡ãƒ¼ã‚¿ã‚’é€ã£ãŸã‚‰ã€é€ã£ãŸãƒ‡ãƒ¼ã‚¿ãŒãã®ã¾ã¾è¿”ã£ã¦ãã‚‹
    const url = "wss://echo.websocket.org";

    // WebSocket æ¥ç¶šã‚’ä½œæˆ
    ws.current = new WebSocket(url);

    // æ¥ç¶šãŒé–‹å§‹ã§ããŸæ™‚
    ws.current.addEventListener("open", e => {
      console.log("æ¥ç¶šé–‹å§‹");
    });

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã£ãŸæ™‚
    // ä»Šå›ã¯ selectFruit é–¢æ•°ã§ send ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒãã®ã¾ã¾è¿”ã£ã¦ãã‚‹
    ws.current.addEventListener("message", e => {
      // fruit ãŒæ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å€¤ã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™
      if (fruit === e.data) {
        alert("Select different fruit.");
      }
      setFruit(e.data);
    });

    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸæ™‚
    ws.current.addEventListener("error", e => {
      console.log("ã‚¨ãƒ©ãƒ¼ : " + e.data);
    });
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  return (
    <div>
      <p>fruit: {fruit}</p>
      <div>
        <button onClick={selectFruit} data-fruit="orange">
          orange
        </button>
        <button onClick={selectFruit} data-fruit="apple">
          apple
        </button>
        <button onClick={selectFruit} data-fruit="banana">
          banana
        </button>
      </div>
    </div>
  );
};

export default Index;
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã ã¨`WebSocket`ã®`messageã‚¤ãƒ™ãƒ³ãƒˆ`ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹stateãŒæ›´æ–°ã•ã‚Œãªã„ãŸã‚ã€**fruitãŒã™ã§ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å€¤ã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™**ã®ç®‡æ‰€ãŒç†æƒ³é€šã‚Šã®æŒ™å‹•ã«ãªã‚Šã¾ã›ã‚“ã€‚

### ãªãœstateãŒæ›´æ–°ã•ã‚Œãªã„ã®ã‹

ä»¥ä¸‹ã®éƒ¨åˆ†ã‚’ã¿ã¦ãã ã•ã„ã€‚

```jsx
ws.current.addEventListener("message", e => {
  // fruit ãŒæ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å€¤ã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™
  if (fruit === e.data) {
    alert("Select different fruit.");
  }
  setFruit(e.data);
});
```

æœ¬æ¥ãªã‚‰`fruit`ã®stateã¨æ–°ã—ãé¸æŠã—ãŸãƒœã‚¿ãƒ³ã‚’æ¯”è¼ƒã—ã¦ã€

- åŒã˜å€¤ãªã‚‰ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™
- é•ã†å€¤ãªã‚‰`setFruit`é–¢æ•°ã‚’ç™ºç«ã™ã‚‹ã ã‘

ã¨ã„ã†ã“ã¨ã‚’ã—ãŸã„ã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚

ã—ã‹ã—ãªãŒã‚‰ã€ã“ã‚Œã ã¨`messageã‚¤ãƒ™ãƒ³ãƒˆ`å†…ã®`fruit`ã«ã¯å¸¸ã«orangeãŒå…¥ã£ã¦ã‚‹çŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚

`setFruit`è‡ªä½“ã¯æ©Ÿèƒ½ã—ã¦ã‚‹ã®ã§ã€returnã®ä¸­ã®`fruit`ï¼ˆä¸‹è¨˜éƒ¨åˆ†ï¼‰ã¯æ›´æ–°ã•ã‚Œã¾ã™ã€‚

```jsx
<p>fruit: {fruit}</p>
```

ã¯ã˜ã‚ã¦ã¿ãŸäººã«ã¯ä¸æ€è­°ãªæŒ™å‹•ã ã¨æ€ã„ã¾ã™ãŒã€ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã‚’çŸ¥ã£ã¦ã„ã‚Œã°ãªã‚“ã¨ãªãç†è§£ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

```js
const [fruit, setFruit] = useState("orange");

//ãƒã‚¦ãƒ³ãƒˆæ™‚ã®ã¿å®Ÿè¡Œ
useEffect(() => {
  ws.current.addEventListener("message", e => {
    // åˆå›ãƒ¬ãƒ³ãƒ€ãƒ¼æ™‚ã®fruit(orange)ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
    if (fruit === e.data) {
      alert("Select different fruit.");
    }
    setFruit(e.data);
  });
}, []);
```

`useEffect`ãŒå‘¼ã³å‡ºã•ã‚ŒãŸæ™‚ã«ã€`addEventListener`ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒ`fruit`ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ã®ã§ã™ãŒã€ä»Šå›ã¯`useEffect`ã®ç¬¬äºŒå¼•æ•°ã‚’ç©ºã«ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒã‚¦ãƒ³ãƒˆæ™‚ã®ã¿ã—ã‹`useEffect`ãŒå®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚ã¤ã¾ã‚Š`fruit`ã®å€¤ãŒãƒã‚¦ãƒ³ãƒˆæ™‚ä»¥é™ã€æ›´æ–°ã•ã‚Œãªã„ã‚ã‘ã§ã™ã€‚

ãã®çµæœã€å¸¸ã«`addEventListener`å†…ã®`fruit`ãŒåˆæœŸå€¤ï¼ˆorangeï¼‰ã‚’å‚ç…§ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

## è§£æ±ºç­–

ã§ã¯ã€ã©ã†ã™ã‚‹ã‹ã¨ã„ã†ã“ã¨ã§ã™ãŒã€ã¾ãšã¯è§£æ±ºã—ãŸã‚³ãƒ¼ãƒ‰ã‚’è¼‰ã›ã¾ã™ã€‚

```jsx
import React, { useEffect, useState, useRef } from "react";

const Index = () => {
  const [fruit, setFruit] = useState("orange");
  const ws = useRef();
  const refFruit = useRef(fruit);

  const selectFruit = e => {
    ws.current.send(e.currentTarget.getAttribute("data-fruit"));
  };

  useEffect(() => {
    const url = "wss://echo.websocket.org";
    ws.current = new WebSocket(url);

    ws.current.addEventListener("open", e => {
      console.log("æ¥ç¶šé–‹å§‹");
    });

    ws.current.addEventListener("message", e => {
      if (refFruit.current === e.data) {
        alert("Select different fruit.");
      }
      setFruit(e.data);
    });

    ws.current.addEventListener("error", e => {
      console.log("ã‚¨ãƒ©ãƒ¼ : " + e.data);
    });
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    refFruit.current = fruit;
  }, [fruit]);

  return (
    <div>
      <p>fruit: {fruit}</p>
      <div>
        <button onClick={selectFruit} data-fruit="orange">
          orange
        </button>
        <button onClick={selectFruit} data-fruit="apple">
          apple
        </button>
        <button onClick={selectFruit} data-fruit="banana">
          banana
        </button>
      </div>
    </div>
  );
};

export default Index;
```

ä»¥ä¸‹ã®ä¸‰ç®‡æ‰€ãŒé‡è¦ã«ãªã‚Šã¾ã™ã€‚

```js
// useRefã§æ–°ã—ãå®šç¾©
const refFruit = useRef(fruit);

// useRefã§å®šç¾©ã—ãŸå¤‰æ•°ã‚’æ¯”è¼ƒã™ã‚‹
ws.current.addEventListener("message", e => {
  if (refFruit.current === e.data) {
    alert("Select different fruit.");
  }
  setFruit(e.data);
});

// fruit ã‚’ä¾å­˜é…åˆ—ã«å…¥ã‚Œã¦ refFruitã‚’æ›´æ–°ã™ã‚‹
useEffect(() => {
  refFruit.current = fruit;
}, [fruit]);
```

è©³ã—ãå†…éƒ¨ã§ã©ã†ãªã£ã¦ã‚‹ã®ã‹ã¯ã‚ˆãã‚ã‹ã‚Šã¾ã›ã‚“ãŒã€`useRef`ã‚’ä½¿ã†ã“ã¨ã«ã‚ˆã£ã¦ã€ã„ã„æ„Ÿã˜ã«å¤‰æ›´å¯èƒ½ãªå€¤ã‚’å®šç¾©ã§ãã‚‹ã¿ãŸã„ã§ã™ã€‚

ç°¡å˜ã«ã„ã†ã¨ã‚¯ãƒ©ã‚¹ã«ãŠã‘ã‚‹`this`ã®ã‚ˆã†ãªæŒ™å‹•ã‚’å®Ÿç¾ã—ã¦ãã‚Œã‚‹ã‚ã‘ã§ã™ã€‚

## ã¾ã¨ã‚

`useRef`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€æ›´æ–°å¯èƒ½ãªå€¤ãŒå®šç¾©ã§ãã‚‹ã¨ã„ã†ã“ã¨ã§ã—ãŸã€‚
ãŸã¾ãƒ¼ã«ã“ã†ã„ã†ã‚±ãƒ¼ã‚¹ã¨å‡ºä¼šã†ã‚“ã§ã™ãŒã€çµæ§‹ãƒˆãƒªãƒƒã‚­ãƒ¼ãªè§£æ±ºæ–¹æ³•ã«æ„Ÿã˜ã‚‹ã®ã§å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ãŸã„ã§ã™ã­ã€‚

## å‚è€ƒ

[å‰¯ä½œç”¨ã®ä¾å­˜ãƒªã‚¹ãƒˆãŒé »ç¹ã«å¤‰ã‚ã‚Šã™ãã‚‹å ´åˆã¯ã©ã†ã™ã‚Œã°ã‚ˆã„ã§ã™ã‹ï¼Ÿ - ãƒ•ãƒƒã‚¯ã«é–¢ã™ã‚‹ã‚ˆãã‚ã‚‹è³ªå• â€“ React](https://ja.reactjs.org/docs/hooks-faq.html#what-can-i-do-if-my-effect-dependencies-change-too-often)

[React Hooks ã® useEffect å†…ã§ setInterval ç­‰ã‚’å‘¼ã³å‡ºã™ã¨ state ç­‰ã®å€¤ãŒå¤‰åŒ–ã—ãªã„å•é¡Œã®è§£æ±ºç­– - Tkr Blog](https://kgtkr.net/blog/2019/03/20/react-hooks-effect)
