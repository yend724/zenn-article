---
title: "Viteã§ç´”ç²‹ãªPugã‚’ä½¿ã†"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["vite", "pug"]
published: true
---

**Vite**ã§**Pug**ã‚’ä½¿ãŠã†ã¨ã™ã‚‹ã¨å°‘ã—å„ä»‹ã ã£ãŸã®ã§ã€ç’°å¢ƒæ§‹ç¯‰ã®æ‰‹é †ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚

ã€Œvite pugã€ç­‰ã§æ¤œç´¢ã™ã‚‹ã¨Vueã‚„Reactã€HTMLã‚’å™›ã¾ã›ã‚‹æ–¹æ³•ã¯ãƒ’ãƒƒãƒˆã™ã‚‹ã®ã§ã™ãŒã€Pugã‚’å˜ä½“ã§ä½¿ã†æ–¹æ³•ã¯ãªã‹ãªã‹ãƒ’ãƒƒãƒˆã—ã¾ã›ã‚“ã€‚ãªã®ã§Viteã§ç´”ç²‹ãªPugã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã‚ˆã†ã¨ã„ã†ã®ãŒæœ¬è¨˜äº‹ã®è¶£æ—¨ã§ã™ã€‚

:::message
å¿…ãšã—ã‚‚Viteã«æœ€é©åŒ–ã•ã‚ŒãŸå†…å®¹ã§ã¯ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
[ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«ã¤ã„ã¦](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«ã¤ã„ã¦)ã¯æ­£ç›´ã‚ˆãã‚ã‹ã‚‰ãªã„ã®ã§ã€ã”äº†æ‰¿ãã ã•ã„ã€‚
:::

# ç’°å¢ƒæ§‹ç¯‰

ã¾ãšã¯æ™®é€šã«ç’°å¢ƒæ§‹ç¯‰ã‚’ã—ã¾ã™ã€‚

## Viteãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

https://vitejs.dev/guide/

å…¬å¼ã‚¬ã‚¤ãƒ‰ã®æ‰‹é †ã«å¾“ã£ã¦Viteã®ç’°å¢ƒæ§‹ç¯‰ã‚’è¡Œã„ã¾ã™ã€‚
æœ¬è¨˜äº‹ã§ã¯`yarn`ã‚’ä½¿ã„ã¾ã™ãŒã€`npm`ã§ã‚‚å•é¡Œãªã„ã¨æ€ã„ã¾ã™ã€‚

```shell:shell
$ yarn create vite
#...
âœ” Project name: â€¦ vite-pug-project
âœ” Select a framework: â€º vanilla
âœ” Select a variant: â€º vanilla-ts
#...
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¯`vite-pug-project`ã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯ãªã—(`vanilla`)ã§TypeScript(`vanilla-ts`)ã‚’é¸æŠã—ã¾ã—ãŸã€‚

```shell:shell
$ cd vite-pug-project #ã€€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
$ yarn # yarn install ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$ yarn dev # é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®ç«‹ã¡ä¸Šã’
```

æŒ‡ç¤ºã•ã‚ŒãŸæ‰‹é †ã«å¾“ã£ã¦ã„ã‚‹ã ã‘ã§ã™ãŒã€ã“ã‚Œã§é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒç«‹ã¡ä¸ŠãŒã‚Šã¾ã™ã€‚
éå¸¸ã«ç°¡å˜ã§ã™ã­ã€‚

```
Hello Vite!
Documentation
```
ã¨ã„ã†æ–‡å­—ãŒãƒ–ãƒ©ã‚¦ã‚¶ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

## ç’°å¢ƒã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

ç¾å ´ã®ãƒ‡ã‚£ã‚¯ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚

```
vite-pug-project
  â”œâ”€â”€ node_modules - ...ç•¥
  â”œâ”€â”€ favicon.svg
  â”œâ”€â”€ index.html
  â”œâ”€â”€ package.json
  â”œâ”€â”€ src
  â”‚   â”œâ”€â”€ main.ts
  â”‚   â”œâ”€â”€ style.css
  â”‚   â””â”€â”€ vite-env.d.ts
  â”œâ”€â”€ tsconfig.json
  â””â”€â”€ yarn.lock
```

ã“ã®ã¾ã¾ã§ã‚‚ã„ã„ã®ã§ã™ãŒã€`index.html`ãŒãƒ«ãƒ¼ãƒˆã«ã‚ã‚‹ã¨[Multi-Page App](https://vitejs.dev/guide/build.html#multi-page-app)ã§ã¯æ‰±ã„ã¥ã‚‰ã„ã®ã§`src`ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­ã«ç§»å‹•ã—ã¾ã™ï¼ˆã¤ã„ã§ã«faviconã‚‚ã„ã‚‰ãªã„ã®ã§å‰Šé™¤ã—ã¦ãã ã•ã„ï¼‰ã€‚

ãã‚Œã«ä¼´ã£ã¦ã€Viteã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã„ã˜ã‚Šã¾ã™ã€‚

https://vitejs.dev/config/

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆã«`vite.config.js`ã‚’ä½œæˆã—ã¦ã€ä¸‹è¨˜ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

```js:vite.config.js
import { resolve } from "path";
import { defineConfig } from "vite";

export default defineConfig({
  root: "src",
  build: {
    outDir: resolve(__dirname, "dist"),
  },
});
```
**root**(`index.html`ãŒç½®ã‹ã‚Œã‚‹å ´æ‰€)ã‚’`src`ã«è¨­å®šã—ã¦ã€ãƒ“ãƒ«ãƒ‰ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’`dist`ã«æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

å ´æ‰€ã‚’ç§»å‹•ã—ãŸã®ã§`index.html`ã‚‚æ›¸ãæ›ãˆã¾ã™ã€‚

```diff html:src/index.html
 <!DOCTYPE html>
 <html lang="ja">
  <head>
    <meta charset="UTF-8" />
-   <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite App</title>
  </head>
  <body>
    <div id="app"></div>
-   <script type="module" src="/src/main.ts"></script>
+   <script type="module" src="/main.ts"></script>
  </body>
 </html>
```

ä¸€åº¦`yarn dev`ã§é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ç«‹ã¡ä¸Šã’ã¦ã¿ã¦ã€å•é¡Œãªã‘ã‚Œã°`yarn build`ã‚³ãƒãƒ³ãƒ‰ã§ãƒ“ãƒ«ãƒ‰ã—ã¦ãã ã•ã„ã€‚

```
vite-pug-project
  â”œâ”€â”€ node_modules - ...ç•¥
  â”œâ”€â”€ dist
  â”‚   â”œâ”€â”€ assets
  â”‚   â”‚   â”œâ”€â”€ index.06d14ce2.css
  â”‚   â”‚   â””â”€â”€ index.ad4f7fa4.js
  â”‚   â””â”€â”€ index.html
  â”œâ”€â”€ package.json
  â”œâ”€â”€ src
  â”‚   â”œâ”€â”€ index.html
  â”‚   â”œâ”€â”€ main.ts
  â”‚   â”œâ”€â”€ style.css
  â”‚   â””â”€â”€ vite-env.d.ts
  â”œâ”€â”€ tsconfig.json
  â”œâ”€â”€ vite.config.js
  â””â”€â”€ yarn.lock
```

ç„¡äº‹ãƒ“ãƒ«ãƒ‰ãŒã§ãã‚Œã°ä¸Šè¨˜ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

## Pugã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹

ã“ã“ã¾ã§ããŸã‚‰Pugã‚’ä½¿ã†ãŸã‚ã®æº–å‚™ã‚’ã—ã¾ã™ã€‚
ã¾ãšã¯Pugã«å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ã‚‡ã†ã€‚

```shell:shell
$ yarn add --dev pug @types/pug @types/node
```

æ¬¡ã«`index.html`ã‚’å‰Šé™¤ã—ã¦ã€`index.pug`ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†ã€‚
ä»¥ä¸‹ã¯å˜ç´”ã«`index.html`å†…å®¹ã‚’`index.pug`ã«æ›¸ãæ›ãˆãŸã ã‘ã®ã‚‚ã®ã«ãªã‚Šã¾ã™ï¼ˆå¤‰åŒ–ãŒã‚ã‹ã‚‹ã‚ˆã†ã«`title`ã ã‘å¤‰æ›´ï¼‰ã€‚

```pug:index.pug
doctype html
html(lang="ja")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    //- index.pugã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸã‚‚ã®ã ã¨ã‚ã‹ã‚‹ã‚ˆã†ã«titleã ã‘å¤‰æ›´ã™ã‚‹
    title Vite Pug App
  body
    #app
    script(src="/main.ts" type="module")
```

### ãƒ“ãƒ«ãƒ‰ç”¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ä½œæˆ

Pugã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ãŸã‚ã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è‡ªä½œã—ã¾ã™ã€‚
ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è‡ªä½œã™ã‚‹æ–¹æ³•ã¯ä»¥ä¸‹ã«è¼‰ã£ã¦ã„ã¾ã™ã€‚
ã¡ã‚ƒã‚“ã¨ä½œã‚ã†ã¨ã™ã‚‹ã¨`rollup.js`ã®çŸ¥è­˜ã‚‚å¿…è¦ã¨ãªã‚Šã¾ã™ï¼ˆãªãŠã€ç§ã¯`Vite`ã‚‚`rollup.js`ã‚‚åˆã‚ã¦å­¦ã³ã¾ã—ãŸï¼‰ã€‚

https://vitejs.dev/guide/api-plugin.html
https://rollupjs.org/guide/en/

ãƒ«ãƒ¼ãƒˆã«`plugins`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦ã€ãã®ä¸­ã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚

```ts:plugins/vite-plugin-pug-build.ts
import fs from "fs";
import type { Plugin } from "vite";
import { compileFile } from "pug";

export const vitePluginPugBuild = (): Plugin => {
  const pathMap: Record<string, string> = {};
  return {
    // Viteå°‚ç”¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‘½åã«ã¯ã€Œvite-plugin-ã€ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ã¤ã‘ã‚‹ã‚‰ã—ã„
    name: "vite-plugin-pug-build",
    enforce: "pre",
    // ãƒ“ãƒ«ãƒ‰æ™‚ã®ã¿
    apply: "build",
    // ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚¾ãƒ«ãƒãƒ¼ã‚’å®šç¾©ã§ãã‚‹
    // ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã®åŠ å·¥ã‚’ã§ãã‚‹
    resolveId(source: string) {
      if (source.endsWith(".pug")) {
        // xxxx.pug ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’
        // xxxx.html ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å½ã‚‹
        const dummy = `${
          source.slice(0, Math.max(0, source.lastIndexOf("."))) || source
        }.html`;
        // xxxx.pug ã¨ xxxx.html å¯¾å¿œè¡¨ã‚’ä½œã‚‹
        pathMap[dummy] = source;
        // xxxx.htmlã€€ã‚’è¿”ã™
        return dummy;
      }
    },
    // ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’å®šç¾©ã§ãã‚‹
    // ã“ã“ã§ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’èª­ã¿è¾¼ã‚€
    load(id: string) {
      if (id.endsWith(".html")) {
        // xxxx.html ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã£ãŸæ™‚
        if (pathMap[id]) {
          // ã‚‚ã¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒ xxxx.pug ã®æ™‚ã¯ã€€ pug ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦è¿”ã™
          const html = compileFile(pathMap[id])();
          return html;
        }
        // ã‚‚ã¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ xxxx.htmlã€€ã®æ™‚ã¯ xxxx.html ã®ä¸­èº«ã‚’ãã®ã¾ã¾è¿”ã™
        return fs.readFileSync(id, "utf-8");
      }
    },
  };
};
```

ä¸Šè¨˜ã§ä½•ã‚’ã‚„ã£ã¦ã„ã‚‹ã‹ç°¡å˜ã«èª¬æ˜ã™ã‚‹ã¨ã€`xxxx.pug`ã«æ¥ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’`xxxx.html`ã¨å½ã£ã¦ï¼ˆ?ï¼‰ã€`xxxx.pug`ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ãŸçµæœã‚’è¿”ã™ã¨ã„ã†ã“ã¨ã‚’ã—ã¦ã„ã¾ã™ã€‚

`resolveId`ã‚„`load`ã¯`rollup.js`ã«å­˜åœ¨ã™ã‚‹ãƒ“ãƒ«ãƒ‰ãƒ•ãƒƒã‚¯ã§ã€ãƒ“ãƒ«ãƒ‰æ™‚ã®ãã‚Œãã‚Œã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°ã§ã™ã€‚
è©³ã—ãã¯ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã”å‚ç…§ãã ã•ã„ã€‚
https://rollupjs.org/guide/en/#build-hooks

å¾Œã»ã©ã‚‚ã†1ã¤ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½œæˆã™ã‚‹ã®ã§ã€`vite-plugin-pug.ts`ã‚’ä½œæˆã—ãƒ©ãƒƒãƒ—ã—ã¦`export`ã—ã¾ã™ã€‚

```ts:plugin/vite-plugin-pug.ts
import { vitePluginPugBuild } from "./vite-plugin-pug-build";

const vitePluginPug = () => {
  return [vitePluginPugBuild()];
};
export default vitePluginPug;
```

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®èª­ã¿è¾¼ã¿ã¨`index.pug`ã‚’ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹ãŸã‚ã«`vite.config.js`ã‚’æ¬¡ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã¾ã™ã€‚

```ts:vite.config.js
import { resolve } from "path";
import { defineConfig } from "vite";
import vitePluginPug from "./plugins/vite-plugin-pug";

export default defineConfig({
  root: "src",
  build: {
    outDir: resolve(__dirname, "dist"),
    rollupOptions: {
      input: {
        main: resolve(__dirname, "src", "index.pug"),
      },
    },
  },
  plugins: [vitePluginPug()],
});
```

ç¾çŠ¶ã®ãƒ‡ã‚£ã‚¯ãƒˆãƒªæ§‹é€ ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```shell
vite-pug-project
  â”œâ”€â”€ dist
  â”‚   â”œâ”€â”€ assets
  â”‚   â”‚   â”œâ”€â”€ index.06d14ce2.css
  â”‚   â”‚   â””â”€â”€ index.ad4f7fa4.js
  â”‚   â””â”€â”€ index.html
  â”œâ”€â”€ package.json
  â”œâ”€â”€ plugins
  â”‚   â”œâ”€â”€ vite-plugin-pug-build.ts
  â”‚   â””â”€â”€ vite-plugin-pug.ts
  â”œâ”€â”€ src
  â”‚   â”œâ”€â”€ index.pug
  â”‚   â”œâ”€â”€ main.ts
  â”‚   â”œâ”€â”€ style.css
  â”‚   â””â”€â”€ vite-env.d.ts
  â”œâ”€â”€ tsconfig.json
  â”œâ”€â”€ vite.config.js
  â””â”€â”€ yarn.lock
```

ã“ã“ã¾ã§ããŸã‚‰ä¸€æ—¦`yarn build`ã—ã¦ã¿ã¾ã™ã€‚

```html:dist/index.html
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Vite Pug Appã€€ãªã®ã§ index.pug ãŒãƒ“ãƒ«ãƒ‰ã•ã‚Œã¦ã„ã‚‹ -->
    <title>Vite Pug App</title>
    <script type="module" crossorigin src="/assets/main.94834e27.js"></script>
    <link rel="stylesheet" href="/assets/main.b16cdc1a.css" />
  </head>
  <body>
    <div id="app"></div>
  </body>
</html>
```

`dist`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`index.html`ãŒãƒ“ãƒ«ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ï¼

### é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ç”¨ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ä½œæˆ

ãƒ“ãƒ«ãƒ‰ã¯ã§ãã¾ã—ãŸãŒã€ã“ã®çŠ¶æ…‹ã§`yarn dev`ã‚’ã—ã¦é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã¦ã‚‚ã€`index.pug`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã¯é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ç”¨ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

`vite-plugin-pug-serve.ts`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã€ä¸‹è¨˜ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¾ã™ã€‚

```ts:plugins/vite-plugin-pug-serve.ts
import fs from "fs";
import { send } from "vite";
import type { ViteDevServer, Plugin } from "vite";
import { compileFile } from "pug";

const transformPugToHtml = (server: ViteDevServer, path: string) => {
  try {
    const compiled = compileFile(path)();
    return server.transformIndexHtml(path, compiled);
  } catch (error) {
    console.log(error);
    return server.transformIndexHtml(path, "Pug Compile Error");
  }
};

export const vitePluginPugServe = (): Plugin => {
  return {
    name: "vite-plugin-pug-serve",
    enforce: "pre",
    // é–‹ç™ºã‚µãƒ¼ãƒãƒ¼æ™‚ã®ã¿
    apply: "serve",
    handleHotUpdate(context) {
      // ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚ŒãŸæ™‚ã«ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹
      // ã“ã®è¨˜è¿°ãŒãªã„ã¨ xxxx.pug ã‚’ä¿å­˜ã—ãŸæ™‚ã«ãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚Œãªã„
      context.server.ws.send({
        type: "full-reload",
      });
      return [];
    },
    configureServer(server) {
      server.middlewares.use(async (req, res, next) => {
        const root = server.config.root;
        let fullReqPath = root + req.url;

        if(fullReqPath.endsWith("/")){
          fullReqPath += "index.html"
        }

        if (fullReqPath.endsWith(".html")) {
          // xxxx.html ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒããŸæ™‚
          if (fs.existsSync(fullReqPath)) {
            // xxxx.html ãŒå­˜åœ¨ã™ã‚‹ãªã‚‰ãã®ã¾ã¾æ¬¡ã®å‡¦ç†ã¸
            return next();
          }

          // xxxx.htmlãŒå­˜åœ¨ã—ãªã„ã¨ãã¯ xxxx.pug ãŒã‚ã‚‹ã‹ç¢ºèªã™ã‚‹
          const pugPath = `${
            fullReqPath.slice(0, Math.max(0, fullReqPath.lastIndexOf("."))) ||
            fullReqPath
          }.pug`;
          if(!fs.existsSync(pugPath)){
            // xxxx.pug ãŒå­˜åœ¨ã—ãªã„ãªã‚‰ 404 ã‚’è¿”ã™
            return send(req, res, "404 Not Found", "html", {});
          }

          // xxxx.pug ãŒå­˜åœ¨ã™ã‚‹ã¨ãã¯ã€€ xxxx.pug ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ãŸçµæœã‚’è¿”ã™
          const html = await transformPugToHtml(server, pugPath);
          return send(req, res, html, "html", {});
        } else {
          // xxxx.htmlã€€ä»¥å¤–ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ãã®ã¾ã¾æ¬¡ã®å‡¦ç†ã¸
          return next();
        }
      });
    },
  };
};
```

ä¸Šè¨˜ã§ã¯é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ãŸçŠ¶æ…‹ã§`xxxx.html`ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒããŸã‚‰`xxxx.pug`ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦çµæœã‚’è¿”ã™ã¨ã„ã†å‡¦ç†ã‚’è¨˜è¿°ã—ã¦ã„ã¾ã™ï¼ˆ`xxxx.html`ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã¨ãã¯ãã‚Œã‚’ãã®ã¾ã¾è¿”ã™ï¼‰ã€‚

https://github.com/vitejs/vite/blob/main/packages/vite/src/node/server/send.ts

`send()`ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¤ã„ã¦ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ãŒã‚ã£ãŸã‚ã‘ã§ã¯ãªã„ã®ã§ã™ãŒã€ä»–ã®æ–¹ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ä½¿ã£ã¦ã„ãŸã®ã§å­˜åœ¨ã‚’çŸ¥ã‚Šã¾ã—ãŸã€‚
ä¸Šè¨˜ã‚’è¦‹ã‚‹é™ã‚Šã ã¨ã€æ‹¡å¼µå­ã®ç¨®é¡ã«ã‚ˆã£ã¦é©åˆ‡ãªãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¦ãã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚ˆã†ã§ã™ã€‚

æœ€å¾Œã«`vite-plugin-pug-build.ts`ã¨åŒæ§˜ã«`vite-plugin-pug.ts`ã‹ã‚‰ã¾ã¨ã‚ã¦`export`ã—ã¾ã™ã€‚

```ts:plugins/vite-plugin-pug.ts
import { vitePluginPugBuild } from "./vite-plugin-pug-build";
import { vitePluginPugServe } from "./vite-plugin-pug-serve";

const vitePluginPug = () => {
  return [vitePluginPugBuild(), vitePluginPugServe()];
};
export default vitePluginPug;
```

ã“ã“ã¾ã§æ›¸ã„ãŸã‚‰`yarn dev`ã—ã¦é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã¦ãã ã•ã„ã€‚

```
Hello Vite!
Documentation
```
ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°å®Œç’§ã§ã™ã€‚


# ãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆ

https://github.com/yend724/vite-pug-boilerplate

ã“ã“ã¾ã§ã®ä½œæ¥­ã‚’ãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ã¾ã¨ã‚ã¦ã‚ã‚Šã¾ã™ã€‚
å…¨ä½“ã®å®Œæˆã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ãŸã„æ–¹ã¯ä¸Šè¨˜ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«ã¤ã„ã¦

æœ¬è¨˜äº‹ã®å†…å®¹ã¯å¿…ãšã—ã‚‚Viteã«æœ€é©åŒ–ã•ã‚ŒãŸï¼ˆæƒ³å®šã•ã‚ŒãŸï¼‰æ–¹æ³•ã§ã¯ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
ä¸€æ—¦ç´°ã‹ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ã“ã¨ã¯ç½®ã„ã¦ãŠã„ã¦ã€å¾“æ¥ã®æ–¹æ³•ã§Pugã‚’ä½¿ãˆã‚‹ã‚ˆã†ã—ã‚ˆã†ã¨ã„ã†ã®ãŒè¶£æ—¨ã«ãªã‚Šã¾ã™ã€‚

```shell
(!) Could not auto-determine entry point from rollupOptions or html files and there are no explicit optimizeDeps.include patterns. Skipping dependency pre-bundling.
```

ä¾‹ãˆã°æœ¬è¨˜äº‹ã®å†…å®¹ã§é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã‚‹ã¨ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«ä¸Šè¨˜ã®ã‚ˆã†ãªæ–‡è¨€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
`vite.config.js`ã§æŒ‡å®šã—ãŸã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆãŒ`xxxx.pug`ãªã®ã§ã€ï¼ˆãŠãã‚‰ãæƒ³å®šã—ã¦ã„ã‚‹æ‹¡å¼µå­ã¨ã¯é•ã£ã¦ï¼Ÿï¼‰ã†ã¾ããƒ‘ã‚¹ã®è§£æ±ºãŒã§ãã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚
ãã‚Œã«ã‚ˆã‚Š`dependency pre-bundling`ãŒã•ã‚Œãªã„ã‚ˆã†ãªã®ã§ã™ãŒã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿ãŒã©ã®ãã‚‰ã„ã‚ã‚‹ã®ã‹ã¯æœªæ¤œè¨¼ã§ã™ï¼ˆã¨ã„ã†ã‹è©³ã—ã„æ–¹ã„ãŸã‚‰æ•™ãˆãŸãã ã•ã„ï¼‰ã€‚

`dependency pre-bundling`ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã«è¼‰ã£ã¦ã„ã¾ã™ã€‚
https://vitejs.dev/guide/dep-pre-bundling.html

# ã¾ã¨ã‚

Viteã§Pugå˜ä½“ã‚’ä½¿ã†æ–¹æ³•ã§ã—ãŸã€‚æ­£æ”»æ³•ã§ã¯ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€webpackã‚„ä»–ã®ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã«å¤‰ã‚ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®1ã¤ã¨ã—ã¦å‚™ãˆã¦ãŠãã®ã¯ååˆ†ã‚ã‚Šã ã¨æ€ã„ã¾ã™ã€‚

ä»Šå›ã¯ã˜ã‚ã¦Vite(ã¾ãŸrollup.js)ã‚’è§¦ã£ãŸã®ã§ã™ãŒã€è‡ªä½œãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ä½œã‚Šæ–¹ã‚„ãƒ“ãƒ«ãƒ‰ãƒ•ãƒƒã‚¯ã«ã¤ã„ã¦ç†è§£ãŒé€²ã‚“ã ã®ã§ã€é•ã†æ©Ÿä¼šã§ã‚‚æ´»ã‹ã›ãã†ã ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚ãœã²çš†ã•ã‚“ã‚‚ã„ã‚ã„ã‚è§¦ã£ã¦ã¿ã¦ãã ã•ã„ã€‚

# å‚è€ƒ

https://vitejs.dev/
https://pugjs.org/api/getting-started.html